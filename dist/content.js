"use strict";(()=>{var p=(...o)=>{console.debug("[NavAI:cs]",...o)};function u(o){let n=o.getBoundingClientRect();if(n.width===0&&n.height===0)return!1;let e=getComputedStyle(o);return e.display!=="none"&&e.visibility!=="hidden"&&parseFloat(e.opacity)>=.1}function v(o){return o.disabled===!0||o.getAttribute("aria-disabled")==="true"}function C(o){if(o.id)return`#${CSS.escape(o.id)}`;let n=o.getAttribute("data-testid");if(n)return`[data-testid="${CSS.escape(n)}"]`;let e=o.getAttribute("aria-label");if(e)return`[aria-label="${CSS.escape(e)}"]`;let r=o.getAttribute("name");if(r)return`${o.tagName.toLowerCase()}[name="${CSS.escape(r)}"]`;let t=[],i=o;for(;i&&i!==document.documentElement;){let s=i.tagName.toLowerCase();if(i.id){t.unshift(`#${CSS.escape(i.id)}`);break}let l=i.parentElement;if(l){let c=i.tagName,a=Array.from(l.children).filter(m=>m.tagName===c);a.length>1&&(s+=`:nth-of-type(${a.indexOf(i)+1})`)}t.unshift(s),i=l}return t.join(" > ")}function T(o){if(o.id)return`//*[@id="${o.id}"]`;let n=[],e=o;for(;e&&e.nodeType===Node.ELEMENT_NODE;){let r=1,t=e.previousElementSibling;for(;t;)t.tagName===e.tagName&&r++,t=t.previousElementSibling;n.unshift(`${e.tagName.toLowerCase()}[${r}]`),e=e.parentElement}return"/"+n.join("/")}function S(o){if(o.id){let t=document.querySelector(`label[for="${CSS.escape(o.id)}"]`);if(t?.textContent)return t.textContent.trim()}let n=o.closest("label");if(n?.textContent)return n.textContent.trim();let e=o.previousElementSibling;if(e?.tagName==="LABEL"&&e.textContent)return e.textContent.trim();let r=o.getAttribute("aria-labelledby");if(r){let t=document.getElementById(r);if(t?.textContent)return t.textContent.trim()}}function L(){let o=["a[href]","button","input","textarea","select",'[role="button"]','[role="link"]','[role="tab"]','[role="menuitem"]','[tabindex="0"]'],n=new Set;for(let t of o)document.querySelectorAll(t).forEach(i=>n.add(i));let e=[],r=0;for(let t of n){let i=t.getBoundingClientRect(),s={index:r++,tag:t.tagName.toLowerCase(),type:t.getAttribute("type")??void 0,id:t.id||void 0,name:t.getAttribute("name")??void 0,ariaLabel:t.getAttribute("aria-label")??void 0,text:(t.textContent??"").trim().substring(0,200),placeholder:t.getAttribute("placeholder")??void 0,dataTestId:t.getAttribute("data-testid")??void 0,role:t.getAttribute("role")??void 0,href:t.href||void 0,cssSelector:C(t),xpath:T(t),rect:{top:i.top+scrollY,left:i.left+scrollX,width:i.width,height:i.height},isVisible:u(t),isDisabled:v(t)};["input","textarea","select"].includes(s.tag)&&(s.formContext={label:S(t),fieldType:t.getAttribute("type")??t.tagName.toLowerCase()}),e.push(s)}return e}function N(){let o=[],n=0,e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode(r){let t=r.parentElement;if(!t||["SCRIPT","STYLE","NOSCRIPT","SVG"].includes(t.tagName))return NodeFilter.FILTER_REJECT;let i=r.textContent?.trim();return!i||i.length<2||!u(t)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});for(;e.nextNode()&&n<2e3;){let r=e.currentNode.textContent.trim();o.push(r),n+=r.length}return o.join(" ").substring(0,2e3)}function A(){return{url:location.href,title:document.title,elements:L(),pageText:N()}}var b=class{host=null;shadow=null;target=null;cleanup=null;scrollClean=null;step=null;stepNum=0;show(n,e){this.hide(),this.step=n,this.stepNum=e;let r=this.resolve(n);if(!r){p("Target element not found");return}this.target=r,this.paint(r,n,e);let t=r.getBoundingClientRect();(t.top<0||t.bottom>innerHeight)&&r.scrollIntoView({behavior:"smooth",block:"center"});let i=P(()=>{this.target&&this.paint(this.target,this.step,this.stepNum)},50);window.addEventListener("scroll",i,!0),window.addEventListener("resize",i),this.scrollClean=()=>{window.removeEventListener("scroll",i,!0),window.removeEventListener("resize",i)},this.listen(r,n)}hide(){if(this.stopListening(),this.scrollClean?.(),this.scrollClean=null,this.target=null,this.shadow)for(let n of Array.from(this.shadow.children))n.tagName!=="STYLE"&&n.remove()}destroy(){this.hide(),this.host?.remove(),this.host=null,this.shadow=null}root(){if(this.shadow)return this.shadow;this.host=document.createElement("div"),this.host.id="navai-host",Object.assign(this.host.style,{position:"fixed",top:"0",left:"0",width:"0",height:"0",zIndex:"2147483647",pointerEvents:"none"}),document.documentElement.appendChild(this.host),this.shadow=this.host.attachShadow({mode:"closed"});let n=document.createElement("style");return n.textContent=R,this.shadow.appendChild(n),this.shadow}paint(n,e,r){let t=this.root();for(let E of Array.from(t.children))E.tagName!=="STYLE"&&E.remove();let i=n.getBoundingClientRect(),s=6,l=h("div","spotlight");x(l,i.top-s,i.left-s,i.width+s*2,i.height+s*2),t.appendChild(l);let c=h("div","ring");x(c,i.top-s-3,i.left-s-3,i.width+s*2+6,i.height+s*2+6),t.appendChild(c);let a=h("div","card");a.innerHTML=`<div class="lbl">Step ${r}</div><div class="ins">${$(e.instruction)}</div><span class="badge">${e.action}</span>`;let m=innerHeight-i.bottom>120,w=i.top>120,d=h("div","arrow");m?(a.style.top=`${i.bottom+s+14}px`,a.style.left=`${g(i.left,12,innerWidth-340)}px`,d.classList.add("arrow-up"),d.style.top=`${i.bottom+s+3}px`,d.style.left=`${i.left+i.width/2-9}px`):w?(a.style.top=`${i.top-s-130}px`,a.style.left=`${g(i.left,12,innerWidth-340)}px`,d.classList.add("arrow-down"),d.style.top=`${i.top-s-15}px`,d.style.left=`${i.left+i.width/2-9}px`):(a.style.top=`${g(i.top,12,innerHeight-140)}px`,a.style.left=`${i.right+16}px`),t.appendChild(d),t.appendChild(a)}resolve(n){let e=n.target;if(e.selector)try{let r=document.querySelector(e.selector);if(r&&u(r))return r}catch{}if(e.strategy==="xpath"&&e.selector)try{let t=document.evaluate(e.selector,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(t&&u(t))return t}catch{}if(e.textHint)return this.findByText(e.textHint);if(e.selector)try{return document.querySelector(e.selector)}catch{}return null}findByText(n){let e=n.toLowerCase().trim(),r=document.querySelectorAll('a,button,input,textarea,select,[role="button"],[role="link"]');for(let t of r)if((t.textContent??"").toLowerCase().trim()===e&&u(t))return t;for(let t of r)if((t.textContent??"").toLowerCase().includes(e)&&u(t))return t;for(let t of r)if((t.getAttribute("aria-label")??"").toLowerCase().includes(e)&&u(t))return t;return null}listen(n,e){this.stopListening();let r=e.action;if(r==="click"){let t=i=>{(n.contains(i.target)||n===i.target)&&(p("Click detected"),this.stopListening(),this.hide(),f({type:"ACTION_COMPLETED",action:"click"}))};document.addEventListener("click",t,!0),this.cleanup=()=>document.removeEventListener("click",t,!0)}else if(r==="type"){let t,i=()=>{n.value&&(clearTimeout(t),t=setTimeout(()=>{p("Type detected"),this.stopListening(),this.hide(),f({type:"ACTION_COMPLETED",action:"type"})},1200))};n.addEventListener("input",i),this.cleanup=()=>{n.removeEventListener("input",i),clearTimeout(t)}}else if(r==="select"){let t=()=>{p("Select detected"),this.stopListening(),this.hide(),f({type:"ACTION_COMPLETED",action:"select"})};n.addEventListener("change",t),this.cleanup=()=>n.removeEventListener("change",t)}}stopListening(){this.cleanup?.(),this.cleanup=null}},R=`
  * { box-sizing: border-box; margin: 0; padding: 0; }

  .spotlight {
    position: fixed; border-radius: 6px; pointer-events: none;
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.42);
    transition: top .2s ease, left .2s ease, width .2s ease, height .2s ease;
  }
  .ring {
    position: fixed; border: 3px solid #6366F1; border-radius: 8px;
    pointer-events: none;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { opacity:1; transform:scale(1); }
    50%     { opacity:.35; transform:scale(1.04); }
  }

  .card {
    position: fixed; pointer-events: none;
    background: #fff; border: 2px solid #6366F1; border-radius: 12px;
    padding: 14px 18px; max-width: 320px; min-width: 180px;
    box-shadow: 0 6px 24px rgba(0,0,0,.15);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    animation: fadeUp .3s ease;
  }
  @keyframes fadeUp {
    from { opacity:0; transform:translateY(6px); }
    to   { opacity:1; transform:translateY(0); }
  }
  .lbl   { font-size:11px; font-weight:700; color:#6366F1;
           text-transform:uppercase; letter-spacing:.6px; margin-bottom:4px; }
  .ins   { font-size:14px; font-weight:500; color:#1e1e2e;
           line-height:1.45; margin-bottom:8px; }
  .badge { display:inline-block; font-size:10px; font-weight:700; color:#fff;
           background:#6366F1; border-radius:4px; padding:2px 8px;
           text-transform:uppercase; letter-spacing:.4px; }

  .arrow { position:fixed; pointer-events:none; width:0; height:0; }
  .arrow-up   { border-left:9px solid transparent; border-right:9px solid transparent;
                border-bottom:11px solid #6366F1; }
  .arrow-down { border-left:9px solid transparent; border-right:9px solid transparent;
                border-top:11px solid #6366F1; }
`;function h(o,n){let e=document.createElement(o);return e.className=n,e}function x(o,n,e,r,t){Object.assign(o.style,{top:`${n}px`,left:`${e}px`,width:`${r}px`,height:`${t}px`})}function $(o){let n=document.createElement("div");return n.textContent=o,n.innerHTML}function g(o,n,e){return Math.max(n,Math.min(o,e))}function P(o,n){let e=0;return(...r)=>{let t=Date.now();t-e>=n&&(e=t,o(...r))}}function f(o){chrome.runtime.sendMessage(o).catch(()=>{})}function k(o){let n=location.href,e=()=>{location.href!==n&&(n=location.href,o(n))},r=history.pushState,t=history.replaceState;history.pushState=function(...c){r.apply(this,c),e()},history.replaceState=function(...c){t.apply(this,c),e()},window.addEventListener("popstate",e),window.addEventListener("hashchange",e);let i,s=new MutationObserver(()=>{clearTimeout(i),i=setTimeout(e,300)}),l=document.body??document.documentElement;s.observe(l,{childList:!0,subtree:!0})}var y=new b;k(o=>{p("SPA nav \u2192",o),f({type:"NAVIGATION_DETECTED",url:o})});chrome.runtime.onMessage.addListener((o,n,e)=>{switch(p("Received:",o.type),o.type){case"EXTRACT_PAGE":return e({type:"PAGE_DATA",data:A()}),!0;case"SHOW_STEP":return y.show(o.step,o.stepNumber),e({ok:!0}),!0;case"CLEAR_OVERLAY":return y.hide(),e({ok:!0}),!0}return!1});p("Content script loaded on",location.href);})();
