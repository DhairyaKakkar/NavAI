var _=new Set(["a","an","the","for","to","of","in","on","and","or","is","my","i","it","this","that"]);function G(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(s=>s.length>1&&!_.has(s))}var H=["apply","start","next","continue","submit","search","book","confirm","proceed","sign","log","register","enroll","flight","hotel","add","create","send","save","checkout","buy","order","pay"],j=["logout","cancel","back","close","skip","no thanks","maybe later","dismiss","advertisement","ad","cookie","privacy","terms","unsubscribe"];function Y(e,s,o,r,p){let i=0,l=e.text.toLowerCase(),a=e.label.toLowerCase();if(o.has(e.selector))return-1e3;if(e.text.length>3&&r.some(n=>n.length>3&&n.includes(e.text.substring(0,20))))return-500;if(p)if(e.isInDialog)i+=30;else return-2e3;e.isInViewport&&(i+=5);for(let n of s){l.includes(n)&&(i+=15),a.includes(n)&&(i+=12);let u=(e.placeholder??"").toLowerCase();u&&u.includes(n)&&(i+=10)}for(let n of H)l.includes(n)&&(i+=8),a.includes(n)&&(i+=6);for(let n of j)l.includes(n)&&(i-=20),a.includes(n)&&(i-=15);return e.tag==="button"&&(i+=5),e.role==="button"&&(i+=4),e.tag==="a"&&(i+=2),e.isInput&&(i+=3),e.rect.width>100&&e.rect.height>30&&(i+=3),e.rect.top<600&&(i+=2),i}function F(e){if(e.isInput){let s=(e.inputType??"text").toLowerCase();return["checkbox","radio","submit","button","file"].includes(s)?"click":e.tag==="select"?"select":"type"}return e.tag==="select"?"select":"click"}function N(e,s){let o=e.text.substring(0,50)||e.label||e.placeholder||"this element";return s==="click"?`Click "${o}"`:s==="type"?`Enter your ${e.label||e.placeholder||"information"} here`:s==="select"?`Select an option from "${o}"`:`Interact with "${o}"`}function O(e,s){if(e.elements.length===0)return null;let o=G(s.goal),r=new Set(s.history.map(n=>n.selector)),p=s.history.map(n=>n.text).filter(n=>n.length>3),i=e.elements.map(n=>({el:n,score:Y(n,o,r,p,e.hasOpenDialog)})).filter(n=>n.score>-500).sort((n,u)=>u.score-n.score);if(i.length===0||i[0].score<10)return null;let l=i[0].el,a=F(l);return{stepNumber:s.step,action:a,selector:l.selector,textHint:l.text.substring(0,60),instruction:N(l,a)}}var v=`You are NavAI, a browser navigation assistant that helps users accomplish tasks step-by-step.

You will receive:
1. The user's goal
2. The current page URL and title
3. Whether a dialog/modal is currently open
4. A numbered list of interactive elements on the page
5. Previous actions already taken

Your job: Pick the SINGLE best next action to make progress toward the goal.

Available actions:
- click(id) \u2014 Click on element with given ID
- type(id) \u2014 Focus on input element with given ID (user will type)
- select(id) \u2014 Focus on dropdown with given ID (user will select)
- wait() \u2014 No clear action available, wait

IMPORTANT RULES:
- Pick exactly ONE action per response
- Use the element ID number from the list
- NEVER repeat an action on the same element from "Previous actions"
- If a dialog/modal is open, you MUST pick an element marked [DIALOG] \u2014 elements behind the dialog are not clickable
- Prefer elements that logically advance the task (e.g., fill inputs before clicking submit)
- If the goal seems complete or you're stuck, use wait()

Response format:
<Thought>Brief reasoning about what to do next</Thought>
<Action>click(5)</Action>`;async function $(e,s,o){let r=e.elements.slice(0,50).map(a=>{let n=[`[${a.idx}]`],u=[];return a.isInDialog&&u.push("DIALOG"),a.isInViewport||u.push("OFFSCREEN"),u.length&&n.push(`[${u.join(",")}]`),n.push(a.tag),a.role!==a.tag&&n.push(`role="${a.role}"`),a.text&&n.push(`"${a.text.substring(0,60)}"`),a.label&&n.push(`label="${a.label}"`),a.placeholder&&n.push(`placeholder="${a.placeholder}"`),a.isInput&&n.push(`(input:${a.inputType||"text"})`),n.join(" ")}).join(`
`),p=s.history.length>0?s.history.slice(-8).map(a=>`Step ${a.step}: ${a.action} on "${a.text}" [${a.selector}]`).join(`
`):"(none yet)",i=e.hasOpenDialog?`
\u26A0\uFE0F A DIALOG/MODAL IS OPEN. You MUST pick an element marked [DIALOG]. Other elements are not clickable.`:"",l=`Goal: ${s.goal}

Current URL: ${e.url}
Page title: ${e.title}${i}

Previous actions (${s.history.length} total):
${p}

Interactive elements on page (${e.elements.length} total):
${r}

What is the single best next action?`;try{let a={"Content-Type":"application/json"},n,u=o.endpoint;o.provider==="openai"?(a.Authorization=`Bearer ${o.apiKey}`,n=JSON.stringify({model:o.model||"gpt-4o-mini",temperature:0,max_tokens:300,messages:[{role:"system",content:v},{role:"user",content:l}],stop:["</Action>"]})):o.provider==="anthropic"?(a["x-api-key"]=o.apiKey,a["anthropic-version"]="2023-06-01",n=JSON.stringify({model:o.model||"claude-sonnet-4-20250514",max_tokens:300,system:v,messages:[{role:"user",content:l}],stop_sequences:["</Action>"]})):(a.Authorization=`Bearer ${o.apiKey}`,n=JSON.stringify({model:o.model,temperature:0,max_tokens:300,messages:[{role:"system",content:v},{role:"user",content:l}]}));let L=new AbortController,D=setTimeout(()=>L.abort(),15e3),y=await fetch(u,{method:"POST",headers:a,body:n,signal:L.signal});if(clearTimeout(D),!y.ok){let w=await y.text().catch(()=>"");return console.error("[NavAI] LLM error:",y.status,w.substring(0,200)),null}let I=await y.json(),f;o.provider==="anthropic"?f=(I.content?.[0]?.text??"")+"</Action>":f=(I.choices?.[0]?.message?.content??"")+"</Action>",console.log("[NavAI] LLM response:",f);let T=f.match(/<Action>(\w+)\((\d+)?\)<\/Action>/i);if(!T)return console.log("[NavAI] Could not parse action from response"),null;let S=T[1].toLowerCase(),k=T[2]?parseInt(T[2],10):-1;if(S==="wait"||k<0)return null;let b=e.elements.find(w=>w.idx===k);if(!b)return console.log("[NavAI] Element not found:",k),null;let M=f.match(/<Thought>(.*?)<\/Thought>/is),R=M?M[1].trim():"",A="click";return S==="type"&&(A="type"),S==="select"&&(A="select"),{stepNumber:s.step,action:A,selector:b.selector,textHint:b.text.substring(0,60),instruction:R||N(b,A)}}catch(a){return a.name==="AbortError"?console.log("[NavAI] LLM request timed out"):console.error("[NavAI] LLM error:",a.message),null}}var c=(...e)=>console.debug("[NavAI:bg]",...e),x={goal:"",active:!1,step:1,current:null,history:[],mode:"heuristic"},t={...x},E=null,P=!1;async function m(){await chrome.storage.local.set({navai_state:t})}async function U(){let e=await chrome.storage.local.get(["navai_state","navai_llm"]);e.navai_state&&(t=e.navai_state),e.navai_llm&&(E=e.navai_llm)}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(()=>{});async function C(e){if(c("Planning...",t.mode),t.mode==="llm"&&E?.apiKey){let s=await $(e,t,E);if(s)return s;c("LLM failed, falling back to heuristic")}return O(e,t)}function W(e){let s=t.history.slice(-3);if(s.length<3)return!1;let o=s.every(p=>p.selector===e.selector),r=e.textHint.length>3&&s.every(p=>p.text===e.textHint);return o||r}async function g(e){if(t.active){if(P){c("Already processing, skipping");return}P=!0,c("Processing tab",e);try{let s=await chrome.tabs.sendMessage(e,{type:"EXTRACT"});if(!s||s.type!=="PAGE_DATA"){c("No page data");return}let o=s.data;c(`Page: ${o.url}, ${o.elements.length} elements, dialog: ${o.hasOpenDialog}`);let r=await C(o);r&&W(r)&&(c("Stuck loop detected"),h({type:"ERROR",msg:"Seems stuck on the same element. Try rephrasing your goal or click Skip."}),r=null),r?(t.current=r,await m(),h({type:"STATE",state:{...t}}),await chrome.tabs.sendMessage(e,{type:"SHOW_STEP",step:r})):(t.current=null,await m(),h({type:"STATE",state:{...t}}),h({type:"ERROR",msg:'No clear next step. Try "Rescan" or rephrase your goal.'}))}catch(s){c("Process error:",s),setTimeout(async()=>{try{let o=await chrome.tabs.sendMessage(e,{type:"EXTRACT"});if(o?.type==="PAGE_DATA"){let r=await C(o.data);r&&(t.current=r,await m(),h({type:"STATE",state:{...t}}),await chrome.tabs.sendMessage(e,{type:"SHOW_STEP",step:r}))}}catch{}},1e3)}finally{P=!1}}}async function d(){let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e?.id}function h(e){chrome.runtime.sendMessage(e).catch(()=>{})}chrome.runtime.onMessage.addListener((e,s,o)=>{switch(c("Message:",e.type),e.type){case"START":return t={...x,goal:e.goal,active:!0,mode:e.mode},m().then(async()=>{h({type:"STATE",state:{...t}});let r=await d();r&&g(r)}),o({ok:!0}),!0;case"STOP":return t={...x},m().then(async()=>{h({type:"STATE",state:{...t}});let r=await d();r&&chrome.tabs.sendMessage(r,{type:"HIDE_OVERLAY"}).catch(()=>{})}),o({ok:!0}),!0;case"SKIP":return t.current&&t.history.push({step:t.step,action:t.current.action,selector:t.current.selector,text:t.current.textHint}),t.step++,t.current=null,m().then(async()=>{h({type:"STATE",state:{...t}});let r=await d();r&&g(r)}),o({ok:!0}),!0;case"RESCAN":return d().then(r=>{r&&g(r)}),o({ok:!0}),!0;case"ACTION_DONE":return t.active?(c("Action done:",e.action),t.current&&t.history.push({step:t.step,action:e.action,selector:t.current.selector,text:t.current.textHint}),t.step++,t.current=null,m().then(()=>{h({type:"STATE",state:{...t}}),setTimeout(async()=>{let r=s.tab?.id??await d();r&&g(r)},e.action==="click"?500:100)}),o({ok:!0}),!0):!1;case"NAV_CHANGE":{if(!t.active)return!1;c("Nav change:",e.url);let r=s.tab?.id;return r&&setTimeout(()=>g(r),600),o({ok:!0}),!0}case"GET_STATE":return o({type:"STATE",state:{...t}}),!0}return!1});chrome.webNavigation.onCompleted.addListener(e=>{e.frameId===0&&t.active&&(c("Page loaded:",e.url),setTimeout(()=>g(e.tabId),500))});U().then(()=>c("Background ready, active:",t.active));
