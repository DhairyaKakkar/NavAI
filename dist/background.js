var N=new Set(["a","an","the","for","to","of","in","on","at","and","or","is","my","i","me","it","do","be","this","that","with","from","by"]);function C(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(n=>n.length>1&&!N.has(n))}var M=["apply","start","begin","next","continue","submit","proceed","go","sign up","register","log in","login","search","get started","enroll","renew","schedule"];function _(e,n,r){if(!e.isVisible||e.isDisabled)return-1e3;let t=0,u=e.text.toLowerCase(),p=(e.ariaLabel??"").toLowerCase(),s=(e.href??"").toLowerCase(),i=(e.placeholder??"").toLowerCase(),o=(e.formContext?.label??"").toLowerCase();for(let c of n)u.includes(c)&&(t+=10),p.includes(c)&&(t+=8),s.includes(c)&&(t+=5),i.includes(c)&&(t+=4),o.includes(c)&&(t+=8);for(let c of M)u.includes(c)&&(t+=5),p.includes(c)&&(t+=4);(e.tag==="button"||e.type==="submit")&&(t+=3),e.role==="button"&&(t+=2),e.tag==="a"&&e.href&&(t+=1),r>1&&["input","textarea","select"].includes(e.tag)&&(t+=2);let g=(e.dataTestId??"").toLowerCase();return/primary|cta|main/.test(g)&&(t+=3),(e.rect.width<10||e.rect.height<10)&&(t-=50),(e.rect.top<-500||e.rect.top>8e3)&&(t-=20),e.id&&(t+=1),e.dataTestId&&(t+=1),t}function A(e){let n=e.tag;if(n==="input"){let r=(e.type??"text").toLowerCase();return["checkbox","radio","submit","button","reset","file","image"].includes(r)?"click":"type"}return n==="textarea"?"type":n==="select"?"select":"click"}function k(e,n,r){let t=e.text.trim().substring(0,60)||e.ariaLabel||e.placeholder||e.name||"this element";switch(n){case"click":return`Click "${t}"`;case"type":return`Type your information in "${e.formContext?.label||e.placeholder||e.ariaLabel||e.name||"the field"}"`;case"select":return`Select an option from "${e.formContext?.label||e.ariaLabel||e.name||"the dropdown"}"`;case"scroll":return"Scroll down to see more options";case"wait":return"Wait for the page to finish loading"}}function v(e,n,r){return{stepTitle:`Step ${r}`,instruction:k(e,n,r),action:n,target:{strategy:e.cssSelector?"css":"text",selector:e.cssSelector,textHint:e.text.substring(0,80)},validation:{event:n==="type"?"input":n==="select"?"change":"click",successHint:`Completed: ${n} on "${e.text.substring(0,40)}"`}}}function P(e,n){if(e.elements.length===0)return null;let r=C(n.goal),t=e.elements.map(i=>({el:i,s:_(i,r,n.currentStepNumber)})).filter(i=>i.s>0).sort((i,o)=>o.s-i.s);if(t.length>0){let i=t[0].el,o=A(i);return v(i,o,n.currentStepNumber)}let u=e.elements.filter(i=>i.isVisible&&!i.isDisabled).filter(i=>["button","a","input","textarea","select"].includes(i.tag)).sort((i,o)=>o.rect.width*o.rect.height-i.rect.width*i.rect.height);if(u.length===0)return null;let p=u[0],s=A(p);return v(p,s,n.currentStepNumber)}var b=`You are NavAI, a navigation assistant.
Given a user's goal and a webpage's interactive elements, determine the single best next action.

Respond with ONLY valid JSON matching this schema:
{
  "stepTitle":   "string",
  "instruction": "string (human\u2011friendly, e.g. 'Click the Apply Now button')",
  "action":      "click|type|select|scroll|wait",
  "target":      { "strategy": "css|xpath|text", "selector": "string", "textHint": "string" },
  "validation":  { "event": "click|input|change|navigation", "successHint": "string" }
}

Rules:
- Pick ONLY ONE action \u2014 the most important next step toward the goal.
- Prefer stable selectors (id, name, aria\u2011label, data\u2011testid).
- Keep instructions concise and friendly.
- If no clear action exists, use action "wait".`;async function L(e,n,r){let t=e.elements.filter(s=>s.isVisible&&!s.isDisabled).slice(0,50).map(s=>{let i=[`[${s.index}] <${s.tag}>`];return s.text&&i.push(`text="${s.text.substring(0,100)}"`),s.ariaLabel&&i.push(`aria="${s.ariaLabel}"`),s.id&&i.push(`id="${s.id}"`),s.name&&i.push(`name="${s.name}"`),s.type&&i.push(`type="${s.type}"`),s.href&&i.push(`href="${s.href.substring(0,100)}"`),s.placeholder&&i.push(`placeholder="${s.placeholder}"`),s.cssSelector&&i.push(`css="${s.cssSelector}"`),i.join(" ")}).join(`
`),u=n.actionHistory.slice(-5).map(s=>`  Step ${s.stepNumber}: ${s.action} at ${s.url}`).join(`
`)||"  (none)",p=[`Goal: "${n.goal}"`,`Current step: ${n.currentStepNumber}`,`URL: ${e.url}`,`Title: ${e.title}`,"","Previous actions:",u,"","Interactive elements:",t,"","Page text (excerpt):",e.pageText.substring(0,500)].join(`
`);try{let s={"Content-Type":"application/json"},i;r.provider==="openai"?(s.Authorization=`Bearer ${r.apiKey}`,i=JSON.stringify({model:r.model||"gpt-4o-mini",temperature:.1,response_format:{type:"json_object"},messages:[{role:"system",content:b},{role:"user",content:p}]})):r.provider==="anthropic"?(s["x-api-key"]=r.apiKey,s["anthropic-version"]="2023-06-01",i=JSON.stringify({model:r.model||"claude-sonnet-4-20250514",max_tokens:512,system:b,messages:[{role:"user",content:p}]})):(s.Authorization=`Bearer ${r.apiKey}`,i=JSON.stringify({model:r.model,temperature:.1,messages:[{role:"system",content:b},{role:"user",content:p}]}));let o=await fetch(r.endpoint,{method:"POST",headers:s,body:i});if(!o.ok)return console.error(`[NavAI] LLM ${o.status}: ${o.statusText}`),null;let g=await o.json(),c;r.provider==="anthropic"?c=g.content?.[0]?.text??"":c=g.choices?.[0]?.message?.content??"";let T=c.match(/```(?:json)?\s*([\s\S]*?)```/),d=JSON.parse(T?T[1].trim():c.trim());return!d.stepTitle||!d.instruction||!d.action||!d.target||!d.validation?(console.error("[NavAI] LLM response missing required fields"),null):d}catch(s){return console.error("[NavAI] LLM planner error:",s),null}}var $=!0,l=(...e)=>{$&&console.debug("[NavAI:bg]",...e)},S={goal:"",isActive:!1,currentStepNumber:1,currentStep:null,actionHistory:[],plannerMode:"heuristic"},a={...S},w=null;async function m(){await chrome.storage.local.set({navai_session:a})}async function D(){let e=await chrome.storage.local.get(["navai_session","navai_llm_config"]);e.navai_session&&(a=e.navai_session),e.navai_llm_config&&(w=e.navai_llm_config)}chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(()=>{});async function x(e){if(l("Planning \u2026",a.plannerMode),a.plannerMode==="llm"&&w?.apiKey){let n=await L(e,a,w);if(n)return n;l("LLM returned null \u2014 falling back to heuristic")}return P(e,a)}function f(){let e={type:"STATE_UPDATE",state:{...a}};chrome.runtime.sendMessage(e).catch(()=>{})}async function E(e,n){try{await chrome.tabs.sendMessage(e,{type:"SHOW_STEP",step:n,stepNumber:a.currentStepNumber})}catch(r){l("showStep failed:",r)}}async function O(e){try{await chrome.tabs.sendMessage(e,{type:"CLEAR_OVERLAY"})}catch{}}async function h(e){if(a.isActive){l("processTab",e);try{let n=await chrome.tabs.sendMessage(e,{type:"EXTRACT_PAGE"});if(!n||n.type!=="PAGE_DATA"){l("Bad EXTRACT_PAGE response");return}let r=n.data;l(`Page: ${r.url}  elements: ${r.elements.length}`);let t=await x(r);t?(a.currentStep=t,await m(),f(),await E(e,t)):(a.currentStep=null,await m(),f(),chrome.runtime.sendMessage({type:"ERROR",message:'Could not determine the next step on this page. Try "Rescan" or rephrase your goal.'}).catch(()=>{}))}catch(n){l("processTab error (will retry):",n),setTimeout(()=>{chrome.tabs.sendMessage(e,{type:"EXTRACT_PAGE"}).then(async r=>{if(r?.type!=="PAGE_DATA")return;let t=await x(r.data);t&&(a.currentStep=t,await m(),f(),await E(e,t))}).catch(()=>{})},1500)}}}async function y(){let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e?.id}chrome.runtime.onMessage.addListener((e,n,r)=>{switch(l("msg:",e.type,n.tab?.id??"ext"),e.type){case"START_GUIDANCE":return a={...S,goal:e.goal,isActive:!0,plannerMode:e.mode},m().then(async()=>{f();let t=await y();t&&h(t)}),r({ok:!0}),!0;case"STOP_GUIDANCE":return a={...S},m().then(async()=>{f();let t=await y();t&&O(t)}),r({ok:!0}),!0;case"RESCAN":return y().then(t=>{t&&h(t)}),r({ok:!0}),!0;case"SKIP_STEP":return a.currentStep&&a.actionHistory.push({stepNumber:a.currentStepNumber,action:a.currentStep.action,url:"",timestamp:Date.now()}),a.currentStepNumber++,a.currentStep=null,m().then(async()=>{f();let t=await y();t&&h(t)}),r({ok:!0}),!0;case"ACTION_COMPLETED":return a.isActive?(l("Action completed:",e.action),a.currentStep&&a.actionHistory.push({stepNumber:a.currentStepNumber,action:e.action,url:n.tab?.url??"",timestamp:Date.now()}),a.currentStepNumber++,a.currentStep=null,m().then(()=>{f();let t=e.action==="click"?600:100;setTimeout(()=>{let u=n.tab?.id;u&&h(u)},t)}),r({ok:!0}),!0):!1;case"GET_STATE":return r({type:"STATE_UPDATE",state:{...a}}),!0;case"NAVIGATION_DETECTED":{if(!a.isActive)return!1;l("SPA nav:",e.url);let t=n.tab?.id;return t&&setTimeout(()=>h(t),800),r({ok:!0}),!0}}return!1});chrome.webNavigation.onCompleted.addListener(e=>{e.frameId===0&&a.isActive&&(l("webNav completed:",e.url),setTimeout(()=>h(e.tabId),600))});D().then(()=>l("Background ready. Active:",a.isActive));
